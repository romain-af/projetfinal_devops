<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Task Manager</title>
  <style>
    li { margin-bottom: 8px; }
    button { margin-left: 5px; }
    .search-container { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>Task Manager</h1>

  <!-- Section de recherche -->
  <div class="search-container">
    <input type="text" id="searchQuery" placeholder="Recherche par mot-clé">
    <button onclick="searchTasks()">Rechercher</button>
    <button onclick="clearSearch()">Effacer la recherche</button>
  </div>

  <!-- Formulaire d'ajout de tâche -->
  <form id="taskForm">
    <input type="text" id="title" placeholder="Titre de la tâche" required>
    <input type="text" id="description" placeholder="Description">
    <input type="date" id="due_date" placeholder="Date d'échéance">
    <!-- Sélection de la priorité -->
    <select id="priority">
      <option value="haute">Haute</option>
      <option value="moyenne" selected>Moyenne</option>
      <option value="basse">Basse</option>
    </select>
    <!-- Champ pour saisir des tags séparés par des virgules -->
    <input type="text" id="tags" placeholder="Tags (séparés par des virgules)">
    <button type="submit">Ajouter</button>
  </form>

  <h2>Liste des tâches</h2>
  <button type="button" onclick="deleteSelected()">Supprimer les tâches sélectionnées</button>
  <ul id="taskList"></ul>

  <script>
    let allTasks = [];

    // Affiche la liste des tâches avec les nouvelles informations
    function afficherTaches(taches) {
      allTasks = taches;
      const taskList = document.getElementById('taskList');
      taskList.innerHTML = '';
      taches.forEach(tache => {
        const li = document.createElement('li');

        // Case à cocher pour sélection multiple
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = tache.id;
        checkbox.className = 'taskCheckbox';
        li.appendChild(checkbox);

        // Affichage des informations de la tâche
        li.innerHTML += ` <strong>${tache.title}</strong> : ${tache.description}` +
                        (tache.due_date ? ` (Échéance: ${tache.due_date})` : "") +
                        ` - Priorité: ${tache.priority}` +
                        (tache.tags && tache.tags.length ? ` - Tags: ${tache.tags.join(", ")}` : "") +
                        ` ${tache.completed ? "(Terminé)" : ""}` +
                        (tache.favorite ? " [Favori]" : "");

        // Bouton Modifier
        const editBtn = document.createElement('button');
        editBtn.textContent = "Modifier";
        editBtn.onclick = function() {
          editTask(tache);
        };
        li.appendChild(editBtn);

        // Bouton pour basculer le statut "terminé"
        const completeBtn = document.createElement('button');
        completeBtn.textContent = tache.completed ? "Marquer comme non terminé" : "Marquer comme terminé";
        completeBtn.onclick = function() {
          toggleComplete(tache);
        };
        li.appendChild(completeBtn);

        // Bouton pour marquer comme favori (basculer)
        const favBtn = document.createElement('button');
        favBtn.textContent = tache.favorite ? "Retirer des favoris" : "Marquer comme favori";
        favBtn.onclick = function() {
          toggleFavorite(tache);
        };
        li.appendChild(favBtn);

        // Bouton Supprimer individuel
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = "Supprimer";
        deleteBtn.onclick = function() {
          deleteTask(tache.id);
        };
        li.appendChild(deleteBtn);

        taskList.appendChild(li);
      });
    }

    // Récupère les tâches depuis le backend, avec option de filtre
    function fetchTasks(query="") {
      let url = 'http://localhost:8000/tasks';
      if(query) {
        url = 'http://localhost:8000/tasks/search?query=' + encodeURIComponent(query);
      }
      fetch(url)
        .then(response => response.json())
        .then(data => afficherTaches(data))
        .catch(error => console.error('Erreur lors de la récupération des tâches :', error));
    }

    // Ajout d'une nouvelle tâche
    document.getElementById('taskForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const due_date = document.getElementById('due_date').value;
      const priority = document.getElementById('priority').value;
      const tagsInput = document.getElementById('tags').value;
      // On divise les tags par virgule et on enlève les espaces superflus
      const tags = tagsInput ? tagsInput.split(",").map(tag => tag.trim()).filter(tag => tag !== "") : [];
      const id = Date.now();
      const task = { id, title, description, due_date, priority, tags, completed: false, favorite: false };

      fetch('http://localhost:8000/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(task)
      })
      .then(response => response.json())
      .then(data => {
        console.log('Tâche ajoutée :', data);
        fetchTasks();
      })
      .catch(error => console.error('Erreur lors de l’ajout de la tâche :', error));
    });

    // Supprime une tâche unique
    function deleteTask(taskId) {
      fetch(`http://localhost:8000/tasks/${taskId}`, {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(data => {
        console.log('Tâche supprimée :', data);
        fetchTasks();
      })
      .catch(error => console.error('Erreur lors de la suppression de la tâche :', error));
    }

    // Supprime les tâches sélectionnées
    function deleteSelected() {
      const checkboxes = document.querySelectorAll('.taskCheckbox:checked');
      const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
      if(ids.length === 0) {
        alert("Aucune tâche sélectionnée.");
        return;
      }
      fetch('http://localhost:8000/tasks/delete-many', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: ids })
      })
      .then(response => response.json())
      .then(data => {
        console.log('Tâches supprimées :', data);
        fetchTasks();
      })
      .catch(error => console.error('Erreur lors de la suppression multiple :', error));
    }

    // Bascule le statut "terminé" d'une tâche
    function toggleComplete(task) {
      const updatedTask = { ...task, completed: !task.completed };
      fetch(`http://localhost:8000/tasks/${task.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedTask)
      })
      .then(response => response.json())
      .then(data => {
        console.log('Tâche mise à jour :', data);
        fetchTasks();
      })
      .catch(error => console.error('Erreur lors de la mise à jour de la tâche :', error));
    }

    // Bascule le statut "favori" d'une tâche
    function toggleFavorite(task) {
      const updatedTask = { ...task, favorite: !task.favorite };
      fetch(`http://localhost:8000/tasks/${task.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedTask)
      })
      .then(response => response.json())
      .then(data => {
        console.log('Tâche mise à jour (favori) :', data);
        fetchTasks();
      })
      .catch(error => console.error('Erreur lors de la mise à jour de la tâche :', error));
    }

    // Permet d'éditer une tâche via des prompt() simples
    function editTask(task) {
      const newTitle = prompt("Modifier le titre:", task.title);
      const newDescription = prompt("Modifier la description:", task.description);
      const newDueDate = prompt("Modifier la date d'échéance (YYYY-MM-DD):", task.due_date || "");
      const newPriority = prompt("Modifier la priorité (haute, moyenne, basse):", task.priority);
      const newTags = prompt("Modifier les tags (séparés par des virgules):", task.tags ? task.tags.join(", ") : "");
      if(newTitle !== null && newDescription !== null) {
        // Traitement des tags
        const tags = newTags ? newTags.split(",").map(tag => tag.trim()).filter(tag => tag !== "") : [];
        const updatedTask = { 
          ...task, 
          title: newTitle, 
          description: newDescription, 
          due_date: newDueDate, 
          priority: newPriority, 
          tags: tags 
        };
        fetch(`http://localhost:8000/tasks/${task.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedTask)
        })
        .then(response => response.json())
        .then(data => {
          console.log('Tâche mise à jour :', data);
          fetchTasks();
        })
        .catch(error => console.error('Erreur lors de la mise à jour de la tâche :', error));
      }
    }

    // Lance la recherche selon le mot-clé saisi
    function searchTasks() {
      const query = document.getElementById('searchQuery').value;
      fetchTasks(query);
    }

    // Réinitialise la recherche et recharge toutes les tâches
    function clearSearch() {
      document.getElementById('searchQuery').value = "";
      fetchTasks();
    }

    // Charger les tâches au chargement de la page
    fetchTasks();
  </script>
</body>
</html>
